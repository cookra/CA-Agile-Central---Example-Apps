<!DOCTYPE html>
<html>
<head>
    <title>LongDropdownGrid</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{_artifactType:"Defect",_customFieldDisplayName:"Defect Dropdown",extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"customFieldDropdown",columnWidth:1}],_rallyServer:null,_currentContext:null,_customFieldCombobox:null,_customFieldName:null,_allowedValuesStore:null,_getAllowedValues:function(scope,allowedValuesCollection){var me=scope,allowedValuesCount=allowedValuesCollection.getCount(),allowedValuesData=[];allowedValuesCollection.load({callback:function(records,operation,success){Ext.Array.each(records,function(record){var allowedValueString=record.get("StringValue");allowedValuesData.push({Name:allowedValueString,Value:allowedValueString})}),me._allowedValuesStore=Ext.create("Ext.data.Store",{fields:["Name","Value"],data:allowedValuesData}),me._getData(me)}})},_hydrateAllowedValuesCollection:function(allowedValuesCollection,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,allowedValuesCollectionRef=allowedValuesCollection.get("_ref");return Rally.data.ModelFactory.getModel({type:"AllowedAttributeValue",success:function(allowedAttributesModel){var allowedAttributesID=Rally.util.Ref.getOidFromRef(allowedValuesCollectionRef);allowedAttributesModel.load(allowedAttributesID,{fetch:["StringValue","ValueIndex"],callback:function(allowedAttributeValue,operation){}})}}),allowedValuesCollection.load({callback:function(records,operation,success){deferred.resolve(records)}}),deferred},_getAttributes:function(scope,data){var me=scope,promises=[],typeDefinition=data[0];promises.push(me._hydrateAttributesCollection(data[0],me)),Deft.Promise.all(promises).then({success:function(results){var theseAttributes=results[0],match_found=!1;Ext.Array.each(theseAttributes,function(attribute){var attributeName=attribute.get("Name");if(attributeName===me._customFieldDisplayName){match_found=!0;var allowedValuesCollection=attribute.getCollection("AllowedValues",{fetch:["StringValue","ValueIndex"],limit:1/0});me._getAllowedValues(me,allowedValuesCollection)}}),match_found===!1&&Ext.Msg.alert("Custom Field not found!","Custom Field with Display Name: "+me._customFieldDisplayName+" not found!")}})},_hydrateAttributesCollection:function(typeDefinition,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,typeDefinitionRef=typeDefinition.get("_ref"),attributesCollection=typeDefinition.getCollection("Attributes",{fetch:["Name","AllowedValues"]}),attributesCount=attributesCollection.getCount();return attributesCollection.load({callback:function(records,operation,success){deferred.resolve(records)}}),deferred},_populateAllowedValuesList:function(){var me=this,attrDefStore=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",autoLoad:!0,filters:[{property:"Name",value:me._artifactType}],listeners:{load:function(store,data,success){me._getAttributes(me,data)}},fetch:["Name","Attributes","AllowedValues"]})},_selectedCallback:function(combobox,data,record){var me=this,recordObjectID=record.get("ObjectID"),selectedValue=combobox.rawValue,objectModel=Rally.data.ModelFactory.getModel({type:me._artifactType,scope:this,success:function(model,operation){model.load(recordObjectID,{scope:this,success:function(model,operation){model.set(me._customFieldName,selectedValue),model.save({callback:function(result,operation){operation.wasSuccessful()}})}})}})},_onDataLoaded:function(store,data){var me=this,records=[];Ext.Array.each(data,function(record){var artifactRef=record.get("_ref"),artifactObjectID=record.get("ObjectID"),artifactFormattedID=record.get("FormattedID"),artifactName=record.get("Name"),artifactType=record.get("_type"),customFieldValue=record.get(me._customFieldName);records.push({_ref:record.get("_ref"),ObjectID:record.get("ObjectID"),FormattedID:{FormattedID:artifactFormattedID,ObjectID:artifactObjectID,Type:artifactType},Name:artifactName,CustomField:customFieldValue})});var formattedIdTemplate="<a href='{0}/#/detail/{1}/{2}' target='_blank'>{3}</a>";this.add({xtype:"rallygrid",store:Ext.create("Rally.data.custom.Store",{data:records,pageSize:50}),columnCfgs:[{text:"Formatted ID",dataIndex:"FormattedID",renderer:function(value){return Ext.String.format(formattedIdTemplate,me._rallyServer,value.Type,value.ObjectID,value.FormattedID)}},{text:"Name",dataIndex:"Name",flex:1},{text:me._customFieldDisplayName,renderer:function(value,model,record){var defaultValue=record.get("CustomField"),id=Ext.id();return Ext.defer(function(){Ext.widget("combobox",{renderTo:id,store:me._allowedValuesStore,queryMode:"local",displayField:"Name",valueField:"Value",listeners:{afterrender:function(){defaultValue&&this.setValue(defaultValue)},select:function(combobox,data){me._selectedCallback(combobox,data,record)}}})},50),Ext.String.format('<div id="{0}"></div>',id)},flex:1}]})},_getData:function(scope){var me=scope,currentUser=me._currentContext.getUser(),currentWorkspaceRef=me._currentContext.getWorkspaceRef(),currentProjectRef=me._currentContext.getProjectRef(),currentProjectScopeUp=me._currentContext.getProjectScopeUp(),currentProjectScopeDown=me._currentContext.getProjectScopeDown();Ext.create("Rally.data.wsapi.Store",{model:me._artifactType,autoLoad:!0,fetch:!0,limit:1/0,listeners:{load:me._onDataLoaded,scope:this},context:{projectScopeUp:currentProjectScopeUp,projectScopeDown:currentProjectScopeDown,workspace:currentWorkspaceRef,project:currentProjectRef}})},_getHostName:function(){testUrl=window.location.hostname||"rally1.rallydev.com",testUrlSplit=testUrl.split("/"),this._rallyHost=1===testUrlSplit.length?"rally1.rallydev.com":testUrlSplit[2],this._rallyServer="https://"+this._rallyHost},launch:function(){var me=this;me._currentContext=me.getContext(),me._customFieldName="c_"+me._customFieldDisplayName.replace(/\s+/g,""),me._getHostName(),me._populateAllowedValuesList()}});

            Rally.launchApp('CustomApp', {
                name:"LongDropdownGrid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
